#summary 如何配置
#labels Phase-Implementation,Featured

=web.xml中servlet的定义=
{{{
<servlet>
   <servlet-name>test</servlet-name>
   <servlet-class>self.micromagic.app.EternaServlet</servlet-class>
   <init-param>
      <param-name>initFiles</param-name>
      <param-value>cp:test/my.xml</param-value>
   </init-param>
</servlet>
<servlet-mapping>
   <servlet-name>test</servlet-name>
   <url-pattern>/test.do</url-pattern>
</servlet-mapping>
}}}

参数initFiles，指配置文件，多个文件可以用";"分割。如果是以"cp:"开头的，表示是classpath中的路径。

如果想要xml修改后能够自动加载，那可以自己定义一个类继承`self.micromagic.app.EternaServlet`，并且实现`self.micromagic.eterna.share.EternaInitialize`接口。然后定义如下方法：
{{{
private static long autoReloadTime()
{
   return 10000L;
}
}}}
此方法必须是静态的，返回类型为long，表示两次判断文件是否有更新的最新间隔时间，单位为毫秒，上面例子中最小间隔时间为10秒。<br>
将web.xml中，相关的servlet类换成你自己定义的类，这样就会在xml文件更新后自动加载了。<br>
如例子中的test.Test类就是这个作用。<br>
<br><br>


=如何使用dtd=
有人说xml配置起来麻烦，但如果xml编写的时候有提示呢，那是不是就和写java代码一样。<br>
下图为如何在eclipse中配置dtd文件。<br>
[http://eterna.googlecode.com/files/eclipse_dtd.gif]<br>
此功能在eclipse的windows——>preferences——>Files and Editors菜单中，点击add后就能出现下半部分，按图中的配置进行设置。<br>
这样，你的xml起始部分按如下代码书写就能有自动提示了。
{{{
<?xml version="1.0" encoding="GBK"?>
<!DOCTYPE eterna-config PUBLIC "eterna" "http://eterna.googlecode.com/files/eterna_1_3.dtd">
}}}
这就是为什么用xml来配置，而不用json的原因。大部分的xml编辑工具，在有dtd或schema的时候，写xml就会变得很容易，而json还没有什么好的编辑工具。<br>
<br><br>


=通用显示界面=
最终的页面是通过jsp来显示了，但这里只需要一个jsp页面就行了，如例子中的view.jsp。
{{{
<%@ page session="false" contentType="text/html;charset=UTF-8" pageEncoding="GBK"%><%@ 
    page import ="self.micromagic.eterna.model.AppData,
                  self.micromagic.app.WebApp,
                  self.micromagic.eterna.view.ViewAdapter,
                  self.micromagic.eterna.view.BaseManager"%><%
   String dataType = request.getParameter(ViewAdapter.DATA_TYPE);
   if (ViewAdapter.DATA_TYPE_ONLYRECORD.equals(dataType)
         || ViewAdapter.DATA_TYPE_ALL.equals(dataType))
   {
      ViewAdapter view = (ViewAdapter) request.getAttribute(WebApp.VIEW_TAG);
      AppData data = (AppData) request.getAttribute(WebApp.APPDATA_TAG);
      if (view != null)
      {
         view.printView(out, data);
      }
   }
   else
   {
      String root = request.getContextPath();
      boolean eterna_initialized = request.getAttribute(BaseManager.ETERNA_INITIALIZED_FLAG) != null;
      int eternaId = BaseManager.createEternaId();
%><html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="pragma" content="no-cache">
<%
      if (!eterna_initialized)
      {
         request.setAttribute(BaseManager.ETERNA_INITIALIZED_FLAG, "1");
%>
<script language="javascript" src="<%= root %>/eterna/jquery.js"></script>
<script language="javascript">
jQuery.noConflict();
var _page_init;
</script>
<script language="javascript" src="<%= root %>/eterna/eterna.js"></script>
<%
      }
%>
<script language="javascript">

function page_eterna_<%= eternaId %>()
{
<%
      ViewAdapter view = (ViewAdapter) request.getAttribute(WebApp.VIEW_TAG);
      AppData data = (AppData) request.getAttribute(WebApp.APPDATA_TAG);
      String width = null;
      String height = null;
      if (view != null)
      {
         width = view.getWidth();
         height = view.getHeight();
         out.print("var eternaData=");
         view.printView(out, data);
         out.print(";");
      }

      String pDebug = request.getParameter("debug");
%>
var eterna_debug = <%= pDebug != null ? pDebug : view != null ? view.getDebug() + "" : "0" %>;
var _eterna;
this.initView = function()
{
<%
      if (view != null)
      {
%>
   jQuery(document).ready(function(){
      var divObj = jQuery("#print_<%= eternaId %>");
<%
         if (width != null)
         {
%>
      divObj.css("width", "<%= width %>");
<%
         }
         if (height != null)
         {
%>
      divObj.css("height", "<%= height %>");
<%
         }
%>
      _eterna = new Eterna(eternaData, eterna_debug, divObj)
      _eterna.reInit();
   });
<%
      }
%>
}
} <% /* end function page_eterna_XXX */ %>
_page_init = new page_eterna_<%= eternaId %>();
_page_init.initView();
</script>
</head>
<body>
<div id="print_<%= eternaId %>" class="eternaFrame"></div>
</body>
</html>
<%
   }
%>
}}}
此页面的功能有：
  # 根据view对象，生成json
  # 根据json对象，生成界面
  # 判断js文件是否已引用，不重复引用
  # 给界面生成一个独立的命名空间，这样在portlet中就不会发生冲突
<br><br>


=公共配置=
公共配置文件为：micromagic_config.properties，此文件一般放在WEB-INF\classes目录下。<br>
里面的主要属性有以下几个：
  # self.micromagic.eterna.digester.initfiles，全局配置文件，这些文件中的配置对象在各个子配置中都可以使用。
  # page.view，通用视图的jsp文件，一般设为/view.jsp，这样export的path属性就可以设为${page.view}，如果文件有变动就只需改变page.view的值，而不用改动所有export的path属性。